<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>èª¿æŸ»çµæœç¢ºèªï¼ˆãƒ•ã‚£ãƒ«ã‚¿ä»˜ãï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: sans-serif; }
    #map { width: 100%; height: 100%; }

    .custom-div-icon div {
      width: 14px; height: 14px; border-radius: 50%;
      border: 2px solid #fff; box-shadow: 0 0 3px rgba(0,0,0,0.4);
    }

    #building-list {
      position: absolute; top: 10px; right: 10px;
      background: rgba(255,255,255,0.95); padding: 10px;
      border-radius: 8px; max-height: 85vh; overflow-y: auto;
      z-index: 1000; font-size: 14px; width: 300px;
    }

    #building-list label { display: block; margin-bottom: 6px; cursor: pointer; }
    .area-toggle { margin-bottom: 6px; }

    .search-button {
      margin-left: 6px; padding: 2px 6px; font-size: 12px;
      border: none; background-color: #3498db;
      color: white; border-radius: 4px; cursor: pointer;
    }
    .search-button:hover { background-color: #2980b9; }

    #back-home {
      position: absolute; bottom: 10px; left: 10px; z-index: 2000;
    }
    #back-home button {
      padding: 8px 14px; font-size: 14px; border: none;
      background-color: #7f8c8d; color: white;
      border-radius: 6px; cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: background 0.3s;
    }
    #back-home button:hover { background-color: #636e72; }

    .filter-group { margin-bottom: 10px; }

    #info-panel {
      position: absolute;
      top: 5px;
      left: 5px;
      height: 100vh;
      width: 700px;
      background: white;
      padding: 20px 16px 16px 16px;
      border-radius: 0 10px 10px 0;
      box-shadow: 2px 0 10px rgba(0,0,0,0.3);
      z-index: 1500;
      overflow-y: auto;
      box-sizing: border-box;
    }

    #info-panel.hidden { display: none; }

    #close-info-panel {
      float: right;
      background: #ccc;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      width: 24px;
      height: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    #info-text {
      margin-bottom: 10px;
      font-size: 15px;
    }

    #image-container {
      width: 100%;
      height: 80%;
      overflow: auto;
      border-radius: 6px;
      margin-bottom: 8px;
      border: 1px solid #ccc;
      background: #f8f8f8;
    }

    #info-image {
      display: block;
      transition: transform 0.3s ease;
      transform-origin: center;
      max-width: none;
    }

    #zoom-controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 8px;
      padding-bottom: 6px;
    }

    #zoom-controls button {
      padding: 6px 14px;
      font-size: 16px;
      border: none;
      background-color: #3498db;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    #zoom-controls button:hover {
      background-color: #2980b9;
    }
  </style>
</head>
<body>
  <div id="back-home">
    <button onclick="location.href='home.html'">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  </div>

  <div id="map"></div>

  <div id="building-list">
    <div class="filter-group">
      <strong>è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿</strong><br/>
      <label><input type="checkbox" class="result-filter" data-color="red" checked> å±é™ºï¼ˆèµ¤ï¼‰</label>
      <label><input type="checkbox" class="result-filter" data-color="yellow" checked> è¦æ³¨æ„ï¼ˆé»„ï¼‰</label>
      <label><input type="checkbox" class="result-filter" data-color="green" checked> èª¿æŸ»æ¸ˆã¿ï¼ˆç·‘ï¼‰</label>
      <label><input type="checkbox" class="result-filter" data-color="gray" checked> æœªè¨­å®š</label>
    </div>
    <div>
      <strong style="cursor:pointer;" onclick="toggleSection('building-items')">â–¼ å»ºç¯‰ç‰©ä¸€è¦§</strong>
      <div id="building-items" style="margin-bottom: 10px;"></div>
    </div>
    <div>
      <strong style="cursor:pointer;" onclick="toggleSection('area-toggle-list')">â–¼ ã‚¨ãƒªã‚¢ä¸€è¦§</strong>
      <div id="area-toggle-list" style="margin-top:4px;"></div>
    </div>
  </div>

  <div id="info-panel" class="hidden">
    <button id="close-info-panel">âœ–</button>
    <div id="info-text">
      <p><strong>æ•´ç†ç•ªå·:</strong> <span id="info-name"></span></p>
      <p><strong>èª¿æŸ»çµæœ:</strong> <span id="info-result"></span></p>
      <p><strong>ã‚¨ãƒªã‚¢:</strong> <span id="info-area"></span></p>
    </div>
    <div id="image-container">
      <img id="info-image" src="" alt="å»ºç‰©ç”»åƒ" />
    </div>
    <div id="zoom-controls">
      <button id="zoom-in">ï¼‹</button>
      <button id="zoom-out">ï¼</button>
    </div>
  </div>

  <script>
    function toggleSection(id) {
      const el = document.getElementById(id);
      el.style.display = (el.style.display === 'none') ? 'block' : 'none';
    }

    document.getElementById('close-info-panel').onclick = () => {
      document.getElementById('info-panel').classList.add('hidden');
    };

    const firebaseConfig = {
      apiKey: "AIzaSyAZ9VaCkHzzmYQOXu8pAAZrzGSFlaW00RM",
      authDomain: "building-survey-support.firebaseapp.com",
      projectId: "building-survey-support",
      storageBucket: "building-survey-support.appspot.com",
      messagingSenderId: "949437812769",
      appId: "1:949437812769:web:example"
    };
    firebase.initializeApp(firebaseConfig);

    let map;
    let areaPolygons = [];
    const markerMap = {};
    const markerMeta = {};
    let zoomScale = 1;

    document.getElementById('zoom-in').onclick = () => {
      zoomScale += 0.2;
      document.getElementById('info-image').style.transform = `scale(${zoomScale})`;
    };

    document.getElementById('zoom-out').onclick = () => {
      zoomScale = Math.max(0.4, zoomScale - 0.2);
      document.getElementById('info-image').style.transform = `scale(${zoomScale})`;
    };

    firebase.auth().signInWithEmailAndPassword("demo01@example.com", "demo20240607")
      .then(() => {
        initializeMap();
        loadEditorMapData();
        loadSurveyData();
      });

    function initializeMap() {
      map = L.map('map').setView([35.05, 136.68], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);
    }

    function loadEditorMapData() {
      const mapData = localStorage.getItem("mapData");
      if (!mapData) return;
      const json = JSON.parse(mapData);
      const toggleList = document.getElementById("area-toggle-list");
      json.areas.forEach(area => {
        const polygon = L.polygon(area.coords, {
          color: area.color || '#3388ff',
          fillOpacity: 0.3
        }).addTo(map);
        polygon.bindPopup(`<strong>${area.name}</strong>`);
        const turfCoords = area.coords.map(([lat, lng]) => [lng, lat]);
        areaPolygons.push({
          name: area.name,
          polygon: turf.polygon([turfCoords.concat([turfCoords[0]])]),
          stats: { total: 0, èµ¤: 0, é»„: 0, ç·‘: 0, æœªè¨­å®š: 0 },
          leafletPolygon: polygon
        });

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = true;
        cb.onchange = () => {
          polygon.setStyle({ opacity: cb.checked ? 1 : 0, fillOpacity: cb.checked ? 0.3 : 0 });
        };
        const label = document.createElement('label');
        label.className = 'area-toggle';
        label.appendChild(cb);
        label.append(` ${area.name}`);
        const searchBtn = document.createElement('button');
        searchBtn.className = 'search-button';
        searchBtn.textContent = 'ğŸ”';
        searchBtn.onclick = () => {
          const stats = areaPolygons.find(a => a.name === area.name).stats;
          alert(`ğŸ“Š ${area.name} ã®ä»¶æ•°\nå±é™ºï¼ˆèµ¤ï¼‰: ${stats.èµ¤}\nè¦æ³¨æ„ï¼ˆé»„ï¼‰: ${stats.é»„}\nèª¿æŸ»æ¸ˆã¿ï¼ˆç·‘ï¼‰: ${stats.ç·‘}\næœªè¨­å®š: ${stats['æœªè¨­å®š']}\nåˆè¨ˆ: ${stats.total}`);
        };
        label.appendChild(searchBtn);
        toggleList.appendChild(label);
      });
    }

    function loadSurveyData() {
      const db = firebase.firestore();
      const structureTypes = ['RC', 'SteelFramed', 'Wooden'];
      const buildingContainer = document.getElementById('building-items');
      const allMarkers = [];

      structureTypes.forEach(type => {
        db.collection('emergency_risk_assessment')
          .doc('guest_group').collection(type)
          .get().then(snaps => {
            snaps.forEach(doc => {
              const d = doc.data();
              const lat = d.building_latitude;
              const lng = d.building_longitude;
              const name = d.building_no || doc.id;
              const result = d.final_result || 'æœªè¨­å®š';
              if (typeof lat !== 'number' || typeof lng !== 'number') return;
              const point = turf.point([lng, lat]);
              const matched = [];
              const resultKey = ['èµ¤', 'é»„', 'ç·‘'].find(k => result.includes(k)) || 'æœªè¨­å®š';

              areaPolygons.forEach(area => {
                if (turf.booleanPointInPolygon(point, area.polygon)) {
                  matched.push(area.name);
                  area.stats[resultKey]++;
                  area.stats.total++;
                }
              });
              if (matched.length === 0) matched.push('ï¼ˆã‚¨ãƒªã‚¢å¤–ï¼‰');

              const color = getColorByResult(result);
              const id = `${type}_${doc.id}`;
              const marker = L.marker([lat, lng], { icon: getColorIcon(color) }).addTo(map);
              marker.bindPopup(`<strong>æ•´ç†ç•ªå·: ${name}</strong><br><b>èª¿æŸ»çµæœ:</b> <span style="color:${color}">${convertResultText(result)}</span><br><b>ã‚¨ãƒªã‚¢:</b> ${matched.join('ã€')}`);
              markerMap[id] = marker;
              markerMeta[id] = { colorCode: getColorCode(result) };
              allMarkers.push(marker);

              // ğŸ”½ ç”»åƒè¡¨ç¤ºå‡¦ç†
              marker.on('click', () => {
                document.getElementById('info-panel').classList.remove('hidden');
                document.getElementById('info-name').textContent = name;
                document.getElementById('info-result').textContent = convertResultText(result);
                document.getElementById('info-area').textContent = matched.join('ã€');
                zoomScale = 1;
                document.getElementById('info-image').style.transform = 'scale(1)';

                const imageMap = {
                  "11107": "image/sample01.jpg",
                  "test01": "image/sample02.jpg",
                  "1": "image/sample.jpg",
                  "test": "image/sample.jpg",
                  "31-5": "image/sample.jpg",
                  "00000001": "image/sample.jpg",
                  "125": "image/sample.jpg",
                  "18": "image/sample.jpg",
                  "1-1": "image/sample.jpg",
                  "ã‚µãƒ³ãƒ—ãƒ«": "image/sample.jpg"
                };

                if (imageMap[name]) {
                  document.getElementById('info-image').src = imageMap[name];
                  document.getElementById('info-image').style.display = "block";
                } else {
                  document.getElementById('info-image').style.display = "none";
                }
              });

              const cb = document.createElement('input');
              cb.type = 'checkbox';
              cb.checked = true;
              cb.dataset.id = id;
              cb.onchange = (e) => {
                const tid = e.target.dataset.id;
                if (e.target.checked) {
                  markerMap[tid].addTo(map);
                } else {
                  map.removeLayer(markerMap[tid]);
                }
              };
              const label = document.createElement('label');
              label.appendChild(cb);
              label.append(` ${name}`);
              buildingContainer.appendChild(label);
            });

            document.querySelectorAll('.result-filter').forEach(filter => {
              filter.addEventListener('change', () => {
                const visibleColors = Array.from(document.querySelectorAll('.result-filter:checked')).map(el => el.dataset.color);
                Object.entries(markerMap).forEach(([id, marker]) => {
                  const color = markerMeta[id].colorCode;
                  if (visibleColors.includes(color)) {
                    marker.addTo(map);
                  } else {
                    map.removeLayer(marker);
                  }
                });
              });
            });

            if (allMarkers.length > 0) {
              const group = L.featureGroup(allMarkers);
              map.fitBounds(group.getBounds().pad(0.2));
            }
          });
      });
    }

    function getColorByResult(result) {
      if (result.includes('ç·‘')) return '#2ecc71';
      if (result.includes('é»„')) return '#f1c40f';
      if (result.includes('èµ¤')) return '#e74c3c';
      return '#888';
    }

    function getColorCode(result) {
      if (result.includes('èµ¤')) return 'red';
      if (result.includes('é»„')) return 'yellow';
      if (result.includes('ç·‘')) return 'green';
      return 'gray';
    }

    function convertResultText(result) {
      if (result.includes('èµ¤')) return 'å±é™ºï¼ˆèµ¤ï¼‰';
      if (result.includes('é»„')) return 'è¦æ³¨æ„ï¼ˆé»„ï¼‰';
      if (result.includes('ç·‘')) return 'èª¿æŸ»æ¸ˆã¿ï¼ˆç·‘ï¼‰';
      return 'æœªè¨­å®š';
    }

    function getColorIcon(color) {
      return L.divIcon({
        className: 'custom-div-icon',
        html: `<div style="background-color:${color}"></div>`,
        iconSize: [16, 16],
        iconAnchor: [8, 8]
      });
    }
  </script>
</body>
</html>
